<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Campaign Monthly Spike/Drop Analyzer ‚Äî Clean UI</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/modern-css-reset/dist/reset.min.css">
  <style>
    :root{
      /* Neutral dark theme */
      --bg: #0b1220;
      --surface: #0e1628;
      --surface-2: #13203a;
      --border: rgba(255,255,255,0.08);
      --muted: #9db0c7;
      --text: #e8f0fb;
      --accent: #06b6d4;
      --accent-2: #0ea5e9;
      --green:#22c55e; --red:#ef4444;
      --shadow: 0 4px 24px rgba(0,0,0,0.35);
      --radius: 12px;
    }
    html,body{height:100%}
    body{
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background: radial-gradient(1200px 600px at 20% -10%, #10203f 0%, transparent 60%),
                  radial-gradient(900px 500px at 110% -20%, #0a1a32 0%, transparent 60%),
                  var(--bg);
      color: var(--text);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      padding: 24px;
    }
    .container{max-width: 1200px; margin: 0 auto}

    /* ---------- header ---------- */
    header{
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }
    .topbar{
      display:flex; align-items:flex-start; justify-content:space-between; gap:16px; flex-wrap:wrap;
    }
    h1{font-size: 22px; font-weight: 700; margin:0}
    .subtitle{font-size: 13px; color: var(--muted); margin-top: 6px}

    /* ---------- cards & layout ---------- */
    .card{
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .controls{
      display: grid;
      grid-template-columns: minmax(220px,auto) 1fr auto auto;
      gap: 12px;
      align-items: stretch;
    }
    @media (max-width: 900px){
      .controls{ grid-template-columns: 1fr; }
    }

    /* ---------- inputs & buttons ---------- */
    .file-wrap{display:flex; gap:10px; align-items:center}
    .visually-hidden{ position:absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

    .btn{
      appearance: none; border: 1px solid var(--border); background: transparent;
      color: var(--text); padding: 10px 14px; border-radius: 10px; font-weight: 600; cursor: pointer;
      transition: transform .04s ease, background-color .2s ease, border-color .2s ease, opacity .2s ease;
    }
    .btn:hover{ border-color: rgba(255,255,255,0.18) }
    .btn:active{ transform: translateY(1px) }
    .btn:focus-visible{ outline: 2px solid var(--accent); outline-offset: 2px }

    .btn-primary{ background: linear-gradient(180deg, var(--accent), var(--accent-2)); color:#03131a; border-color: transparent }
    .btn-primary:hover{ filter: brightness(1.05) }
    .btn-ghost{ background: rgba(255,255,255,0.03) }

    .chooseFileLabel{ display:inline-flex; align-items:center; gap:10px; }
    .chooseFileLabel .chip{
      background: rgba(255,255,255,0.06); border:1px dashed var(--border); padding:8px 10px; border-radius:10px; font-size:13px; color: var(--muted);
    }

    .fieldset{ display:flex; flex-direction:column; gap:10px }
    .thresholds{ display:grid; grid-template-columns: repeat(5, minmax(90px, 1fr)); gap: 10px; align-items:end }
    .thresholds strong{ color: var(--text) }
    .input{
      width:100%; padding:10px 12px; border-radius:10px; background: rgba(255,255,255,0.02);
      border:1px solid var(--border); color: var(--text); font: inherit
    }
    .select{ width:100%; padding:10px 12px; border-radius:10px; background: rgba(255,255,255,0.02); border:1px solid var(--border); color: var(--text) }

    /* ---------- tabs ---------- */
    .tabs{ display:flex; gap:8px; background: var(--surface); border: 1px solid var(--border); border-radius: 999px; padding:6px; }
    .tabBtn{ border:none; background: transparent; color: var(--muted); font-weight:600; padding:8px 14px; border-radius: 999px; cursor:pointer }
    .tabBtn.active{ background: rgba(6,182,212,0.18); color: var(--text) }

    /* ---------- tables ---------- */
    .table-wrap{ overflow:auto; border:1px solid var(--border); border-radius: var(--radius); }
    table{ width:100%; border-collapse: collapse; font-size: 13px; }
    thead th{ position: sticky; top: 0; background: var(--surface-2); color: var(--muted); text-align:left; font-weight:600; }
    th, td{ padding: 10px 12px; border-bottom: 1px dashed rgba(255,255,255,0.06); vertical-align: top }
    tbody tr:hover{ background: rgba(255,255,255,0.02) }

    .kpi-green{ color: var(--green); font-weight: 700 }
    .kpi-red{ color: var(--red); font-weight: 700 }
    .note{ color:#dbeafe }

    #statusMsg{ margin-top: 8px; color: var(--muted) }
    footer{ margin-top: 18px; color: var(--muted); font-size:13px; text-align:center }
    .small{ font-size: 12px; color: var(--muted) }
    .infobar{ display:flex; gap:10px; align-items:flex-start; background: rgba(6,182,212,0.08); border:1px solid rgba(6,182,212,0.25); border-radius: var(--radius); padding:12px; }
    .infobar em{ color: var(--muted) }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="topbar">
        <div>
          <h1>Campaign Monthly Spike/Drop Analyzer</h1>
          <p class="subtitle">Upload .xlsx (Month, Campaign, Spend, Impressions, Clicks). CTR, CPM, CPC auto-calculated. Export includes Good / Mixed / Overall Decline + Description + Raw Data.</p>
        <div class="infobar" role="note" aria-label="About this report">
          <div>‚ÑπÔ∏è</div>
          <div>
            <strong>About this report</strong><br>
            This analyzer compares the latest month‚Äôs campaign performance against either the <em>average of all previous months</em> or <em>just the previous month</em>. It flags significant spikes or drops in Spend, CTR, CPC, and CPM, and groups campaigns as <strong>Good</strong>, <strong>Mixed</strong>, or <strong>Overall Decline</strong>.
          </div>
        </div>
      </div>
      </div>

      <div class="controls">
        <div class="card file-wrap">
          <label class="chooseFileLabel">
            <input id="file" class="visually-hidden" type="file" accept=".xls,.xlsx,.csv" />
            <button class="btn btn-primary" type="button" onclick="document.getElementById('file').click()">üìÇ Choose File</button>
            <span id="fileName" class="chip">No file selected</span>
          </label>
        </div>

        <div class="card fieldset">
          <strong>Thresholds (%)</strong>
          <div class="thresholds">
            <label>
              <span class="small">Spend</span>
              <input id="th_spend" class="input" type="number" min="0" value="50" />
            </label>
            <label>
              <span class="small">CPC</span>
              <input id="th_cpc" class="input" type="number" min="0" value="50" />
            </label>
            <label>
              <span class="small">CPM</span>
              <input id="th_cpm" class="input" type="number" min="0" value="50" />
            </label>
            <label>
              <span class="small">CTR</span>
              <input id="th_ctr" class="input" type="number" min="0" value="50" />
            </label>
            <div>
              <span class="small">&nbsp;</span>
              <button id="analyze" class="btn btn-primary" type="button">üîç Analyze</button>
            </div>
          </div>
        </div>

        <div class="card fieldset">
          <label class="small"><strong>Comparison Mode</strong></label>
          <select id="compareMode" class="select">
            <option value="previous">Current vs Previous Month</option>
            <option value="average">Current vs Avg of All Previous Months</option>
          </select>
        </div>

        <div class="card fieldset" style="justify-content:center">
          <button id="downloadSummary" class="btn btn-ghost" style="display:none" type="button">‚¨áÔ∏è Download Summary</button>
          <span class="small">Sorted by absolute % change</span>
        </div>
      </div>
    </header>

    <div id="statusMsg">Load a file to start.</div>

    <section id="previewSection" class="card" style="margin-top:12px; display:none">
      <h3 style="margin:0 0 8px 0">üîé File Preview (first 5 rows)</h3>
      <div class="table-wrap"><table id="previewTable"><thead></thead><tbody></tbody></table></div>
    </section>

    <section style="margin-top:12px; display:flex; align-items:center; justify-content:space-between; gap:12px">
      <div class="tabs">
        <button class="tabBtn active" data-tab="good" id="tabGood">Good</button>
        <button class="tabBtn" data-tab="mixed" id="tabMixed">Mixed</button>
        <button class="tabBtn" data-tab="decline" id="tabDecline">Overall Decline</button>
      </div>
    </section>

    <section id="summarySection" class="card" style="margin-top:12px; display:none">
      <h3 style="margin:0 0 8px 0">üìà Final Month Summary</h3>
      <div class="table-wrap">
        <table id="summaryTable">
          <thead>
            <tr><th>Campaign</th><th>Base Metric</th><th>Previous</th><th>Current</th><th>% Change</th><th>Direction</th><th>Performance</th><th>Note</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <footer>Campaigns with ‚ÄúDrive New Website Visitors‚Äù, ‚ÄúRe-Engage Website Visitors‚Äù, and ‚ÄúDrive Form Submissions‚Äù are merged.</footer>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    /* ---------- helpers (unchanged core logic) ---------- */
    function showStatus(msg, color='var(--muted)'){const s=document.getElementById('statusMsg'); s.style.color=color; s.textContent = msg;}
    function parseMonthToKey(v){
      try{
        if(!v) return null;
        if(v instanceof Date && !isNaN(v)) return `${v.getFullYear()}-${String(v.getMonth()+1).padStart(2,'0')}`;
        if(typeof v === 'number'){ const d=new Date(Date.UTC(1899,11,30) + v*86400000); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
        const s = String(v).trim(); const d = new Date(s);
        if(!isNaN(d)) return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        return s;
      }catch{return v;}
    }
    function excelSerialToDate(serial){ return new Date(Date.UTC(1899,11,30) + serial * 86400000); }
    function pnum(v){ if(v===''||v==null) return 0; const n=Number(String(v).replace(/[^0-9eE+\-.]/g,'')); return isNaN(n)?0:n; }
    function fmt(val, metric){ if(metric === 'CTR') return val.toFixed(2)+'%'; if(['CPM','CPC','Spend'].includes(metric)) return '$'+val.toFixed(2); return val.toFixed(2); }

    function buildNote(changeMap, baseMetric, forHtml){
      const items = Object.keys(changeMap)
        .map(m => ({ m: m.toUpperCase(), pct: changeMap[m] }))
        .filter(x => x.pct !== null && !isNaN(x.pct) && Math.abs(x.pct) > 0)
        .sort((a,b) => Math.abs(b.pct) - Math.abs(a.pct));
      if(!items.length) return '';
      const main = items[0];
      const mainVerb = main.pct > 0 ? 'spiked' : 'dropped';
      const mainTextMetric = (forHtml && main.m === baseMetric.toUpperCase()) ? `<strong>${main.m}</strong>` : main.m;
      let text = `${mainTextMetric} ${mainVerb} by ${Math.abs(main.pct).toFixed(2)}%`;
      if(items.length > 1){
        const restParts = items.slice(1).map(x => {
          const verb = x.pct > 0 ? 'increased' : 'decreased';
          return `${x.m} ${verb} by ${Math.abs(x.pct).toFixed(2)}%`;
        });
        if(restParts.length === 1) text += `; ${restParts[0]}`;
        else if(restParts.length === 2) text += `; ${restParts[0]} and ${restParts[1]}`;
        else text += `; ${restParts.slice(0,restParts.length-1).join(', ')} and ${restParts[restParts.length-1]}`;
      }
      return text;
    }
    function metricPerformance(metric, pctChange){
      if(pctChange === null || isNaN(pctChange)) return 'Neutral';
      if(['Spend','CTR'].includes(metric)) return pctChange > 0 ? 'Good' : 'Bad';
      if(['CPM','CPC'].includes(metric)) return pctChange > 0 ? 'Bad' : 'Good';
      return 'Neutral';
    }

    let rawData = []; let processed = { good: [], mixed: [], decline: [] };

    document.getElementById('file').addEventListener('change', e => {
      const f = e.target.files[0];
      document.getElementById('fileName').textContent = f ? f.name : 'No file selected';
      if(!f){ showStatus('‚ùå No file selected','var(--red)'); return; }
      showStatus('üì• Reading file...','var(--accent)');
      const r = new FileReader();
      r.onload = ev => {
        try{
          const wb = XLSX.read(ev.target.result, {type:'array'});
          const ws = wb.Sheets[wb.SheetNames[0]];
          rawData = XLSX.utils.sheet_to_json(ws, { defval: '' });
          if(!rawData.length) throw new Error('Empty sheet');
          showStatus(`‚úÖ Loaded ${rawData.length} rows from ${wb.SheetNames[0]}`, 'var(--green)');
          const keys = Object.keys(rawData[0]);
          const head = document.querySelector('#previewTable thead');
          const body = document.querySelector('#previewTable tbody');
          head.innerHTML = '<tr>' + keys.map(k=>`<th>${k}</th>`).join('') + '</tr>';
          body.innerHTML = '';
          rawData.slice(0,5).forEach(rw => { body.innerHTML += `<tr>${keys.map(k=>`<td>${rw[k]}</td>`).join('')}</tr>`; });
          document.getElementById('previewSection').style.display = 'block';
        }catch(err){
          showStatus('‚ùå Failed to parse file: '+err.message,'var(--red)');
          rawData = [];
        }
      };
      r.readAsArrayBuffer(f);
    });

    const tabBtns = document.querySelectorAll('.tabBtn');
    tabBtns.forEach(b => b.addEventListener('click', () => {
      tabBtns.forEach(x => x.classList.remove('active'));
      b.classList.add('active');
      renderTableForTab(b.dataset.tab);
    }));

    function renderTableForTab(tab){
      const tbody = document.querySelector('#summaryTable tbody');
      tbody.innerHTML = '';
      const arr = (tab === 'good') ? processed.good : (tab === 'mixed' ? processed.mixed : processed.decline);
      arr.forEach(s => {
        const tr = document.createElement('tr');
        const colorClass = ((s.BaseMetric === 'Spend' || s.BaseMetric === 'CTR') ? (s.Direction === 'Spike' ? 'kpi-green' : 'kpi-red') : (s.Direction === 'Spike' ? 'kpi-red' : 'kpi-green'));
        const perfClass = s.Performance === 'Good' ? 'kpi-green' : (s.Performance === 'Bad' ? 'kpi-red' : '');
        const htmlNote = buildNote(s.changeMap, s.BaseMetric, true);
        tr.innerHTML = `<td>${s.Campaign}</td>
                        <td>${s.BaseMetric}</td>
                        <td>${s.PrevLabel}: ${fmt(s.PrevVal, s.BaseMetric)}</td>
                        <td>${s.CurMonth}: ${fmt(s.CurVal, s.BaseMetric)}</td>
                        <td>${s.Change.toFixed(2)}%</td>
                        <td class="${colorClass}">${s.Direction}</td>
                        <td class="${perfClass}">${s.Performance}</td>
                        <td class="note">${htmlNote}</td>`;
        tbody.appendChild(tr);
      });
    }

    document.getElementById('analyze').addEventListener('click', () => {
      if(!rawData.length){ showStatus('‚ö†Ô∏è Please upload a valid file first.','var(--red)'); return; }
      showStatus('üîç Analyzing...','var(--accent)');

      try{
        const headers = Object.keys(rawData[0]);
        const required = ['Month','Campaign','Spend','Impressions','Clicks'];
        const colMap = {};
        for(const c of required){
          const f = headers.find(h => h.toLowerCase() === c.toLowerCase());
          if(!f){ showStatus(`‚ùå Missing column: ${c}`,'var(--red)'); return; }
          colMap[c] = f;
        }

        const campaigns = {}; const months = new Set();
        rawData.forEach(r => {
          let name = String(r[colMap['Campaign']]).trim();
          name = name.replace(/ - (?:(?:Drive New|Re-Engage) Website Visitors|Drive Form Submissions)$/i,'');
          const m = parseMonthToKey(r[colMap['Month']]);
          months.add(m);
          if(!campaigns[name]) campaigns[name] = {};
          if(!campaigns[name][m]) campaigns[name][m] = { Spend:0, Impressions:0, Clicks:0 };
          const c = campaigns[name][m];
          c.Spend += pnum(r[colMap['Spend']]);
          c.Impressions += pnum(r[colMap['Impressions']]);
          c.Clicks += pnum(r[colMap['Clicks']]);
        });

        Object.values(campaigns).forEach(mths => {
          Object.values(mths).forEach(v => {
            v.CTR = v.Impressions ? (v.Clicks / v.Impressions) * 100 : 0;
            v.CPM = v.Impressions ? (v.Spend / v.Impressions) * 1000 : 0;
            v.CPC = v.Clicks ? (v.Spend / v.Clicks) : 0;
          });
        });

        const monthList = Array.from(months).filter(Boolean).sort();
        if(!monthList.length){ showStatus('‚ùå Could not parse any valid months','var(--red)'); return; }
        const lastMonth = monthList[monthList.length-1];
        const ths = { Spend:+th_spend.value||0, CPC:+th_cpc.value||0, CPM:+th_cpm.value||0, CTR:+th_ctr.value||0 };
        const mode = document.getElementById('compareMode').value;

        const changeRecords = {}, baselineRecords = {};
        Object.keys(campaigns).forEach(camp => {
          const mths = campaigns[camp];
          const sorted = monthList.filter(m => mths[m]);
          if(sorted.length < 2) return;
          const curr = mths[sorted[sorted.length-1]];
          let baseline = {};
          if(mode === 'average'){
            const prevMonths = sorted.slice(0,-1);
            const cnt = prevMonths.length;
            const sums = prevMonths.reduce((acc, mm) => {
              const val = mths[mm];
              acc.Spend += (val.Spend||0);
              acc.CPM += (val.CPM||0);
              acc.CPC += (val.CPC||0);
              acc.CTR += (val.CTR||0);
              return acc;
            }, {Spend:0, CPM:0, CPC:0, CTR:0});
            baseline.Spend = sums.Spend / cnt;
            baseline.CPM = sums.CPM / cnt;
            baseline.CPC = sums.CPC / cnt;
            baseline.CTR = sums.CTR / cnt;
          } else {
            const prev = mths[sorted[sorted.length-2]];
            baseline.Spend = prev.Spend; baseline.CPM = prev.CPM; baseline.CPC = prev.CPC; baseline.CTR = prev.CTR;
          }
          baselineRecords[camp] = {...baseline};
          const rec = { Spend:null, CPC:null, CPM:null, CTR:null };
          if(typeof baseline.Spend === 'number' && baseline.Spend !== 0) rec.Spend = ((curr.Spend - baseline.Spend) / baseline.Spend) * 100;
          if(typeof baseline.CPC === 'number' && baseline.CPC !== 0) rec.CPC = ((curr.CPC - baseline.CPC) / baseline.CPC) * 100;
          if(typeof baseline.CPM === 'number' && baseline.CPM !== 0) rec.CPM = ((curr.CPM - baseline.CPM) / baseline.CPM) * 100;
          if(typeof baseline.CTR === 'number' && baseline.CTR !== 0) rec.CTR = ((curr.CTR - baseline.CTR) / baseline.CTR) * 100;
          changeRecords[camp] = rec;
        });

        const significant = {};
        Object.keys(changeRecords).forEach(camp => {
          const rec = changeRecords[camp];
          const sigs = [];
          ['Spend','CPC','CPM','CTR'].forEach(metric => {
            const pct = rec[metric];
            if(pct === null || isNaN(pct)) return;
            if(Math.abs(pct) >= (ths[metric] || 0)){
              const perf = metricPerformance(metric, pct);
              sigs.push({ metric, pct, perf });
            }
          });
          if(sigs.length) significant[camp] = sigs;
        });

        const collapsedRows = [];
        Object.keys(significant).forEach(camp => {
          const sigs = significant[camp];
          sigs.sort((a,b) => Math.abs(b.pct) - Math.abs(a.pct));
          const base = sigs[0];
          const mths = campaigns[camp];
          const sorted = monthList.filter(m => mths[m]);
          const prevLabel = mode === 'average' ? `Avg of ${sorted.slice(0,-1).length} months` : sorted[sorted.length-2];
          const prevVal = mode === 'average' ? (sorted.slice(0,-1).reduce((a,b)=>a + mths[b][base.metric],0) / sorted.slice(0,-1).length) : mths[sorted[sorted.length-2]][base.metric];
          const currVal = mths[sorted[sorted.length-1]][base.metric];
          const change = base.pct; const direction = change > 0 ? 'Spike' : 'Drop';

          const changeMap = {}; ['Spend','CPC','CPM','CTR'].forEach(m => {
            const found = sigs.find(s => s.metric === m); changeMap[m] = found ? found.pct : null;
          });

          const goods = sigs.filter(s => metricPerformance(s.metric, s.pct) === 'Good').length;
          const bads = sigs.filter(s => metricPerformance(s.metric, s.pct) === 'Bad').length;
          let performance = 'Mixed'; if(goods > 0 && bads === 0) performance = 'Good'; else if(bads > 0 && goods === 0) performance = 'Bad';

          const notePlain = buildNote(changeMap, base.metric, false);

          collapsedRows.push({
            Campaign: camp, BaseMetric: base.metric,
            PrevLabel: prevLabel, PrevVal: prevVal,
            CurMonth: lastMonth, CurVal: currVal,
            Change: change, Direction: direction,
            Performance: performance, NotePlain: notePlain,
            changeMap
          });
        });

        const good = [], mixed = [], decline = [];
        collapsedRows.forEach(r => { if(r.Performance === 'Good') good.push(r); else if(r.Performance === 'Bad') decline.push(r); else mixed.push(r); });
        const sortByAbs = arr => arr.sort((a,b)=>Math.abs(b.Change) - Math.abs(a.Change));
        sortByAbs(good); sortByAbs(mixed); sortByAbs(decline);
        processed = { good, mixed, decline };

        document.getElementById('summarySection').style.display = (good.length+mixed.length+decline.length) ? 'block' : 'none';
        renderTableForTab('good');
        document.getElementById('tabGood').textContent = `Good (${good.length})`;
        document.getElementById('tabMixed').textContent = `Mixed (${mixed.length})`;
        document.getElementById('tabDecline').textContent = `Overall Decline (${decline.length})`;

        showStatus(`‚úÖ Analysis complete. Good: ${good.length}, Mixed: ${mixed.length}, Overall Decline: ${decline.length}.`, 'var(--green)');
        const dl = document.getElementById('downloadSummary'); dl.style.display = 'inline-block'; dl.onclick = () => buildAndDownloadExcel({good,mixed,decline, rawData, mode, ths});
      }catch(err){ showStatus('‚ùå Analysis failed: '+err.message,'var(--red)'); }
    });

    function buildAndDownloadExcel({good,mixed,decline, rawData, mode, ths}){
      const wb = XLSX.utils.book_new();
      function makeSheetFromRows(rows){
        const sheetData = rows.map(r => ({
          Campaign: r.Campaign,
          Base_Metric: r.BaseMetric,
          Previous: r.PrevLabel,
          Previous_Value: r.PrevVal,
          Current_Month: r.CurMonth,
          Current_Value: r.CurVal,
          Change_Percent: r.Change / 100,
          Direction: r.Direction,
          Performance: r.Performance,
          Note: r.NotePlain
        }));
        return XLSX.utils.json_to_sheet(sheetData);
      }
      const wsGood = makeSheetFromRows(good); formatSheetColumnsPerRow(wsGood); XLSX.utils.book_append_sheet(wb, wsGood, 'Good Performance');
      const wsMixed = makeSheetFromRows(mixed); formatSheetColumnsPerRow(wsMixed); XLSX.utils.book_append_sheet(wb, wsMixed, 'Mixed Performance');
      const wsDecline = makeSheetFromRows(decline); formatSheetColumnsPerRow(wsDecline); XLSX.utils.book_append_sheet(wb, wsDecline, 'Overall Decline');

      const generationDate = (new Date()).toLocaleString('en-GB', { timeZone: 'Asia/Kolkata', year:'numeric', month:'short', day:'numeric' });
      const descRows = [
        { Property: 'Report Name', Value: 'Campaign Monthly Spike/Drop Analyzer' },
        { Property: 'Generated On', Value: generationDate },
        { Property: 'Comparison Mode', Value: mode === 'average' ? 'Current vs Avg of All Previous Months' : 'Current vs Previous Month' },
        { Property: 'Thresholds (Spend, CPC, CPM, CTR %)', Value: `${ths.Spend}%, ${ths.CPC}%, ${ths.CPM}%, ${ths.CTR}%` },
        { Property: 'Metric Definitions', Value: 'Spend, Impressions, Clicks are raw. CTR = Clicks/Impressions (%). CPM = Spend/Impressions*1000. CPC = Spend/Clicks.' },
        { Property: 'Performance Logic', Value: 'Spend & CTR: Spike = Good, Drop = Bad. CPM & CPC: Spike = Bad, Drop = Good.' },
        { Property: 'Sheet Descriptions', Value: 'Good Performance: all significant metrics Good. Mixed Performance: mix of Good & Bad. Overall Decline: all significant metrics Bad.' }
      ];
      const wsDesc = XLSX.utils.json_to_sheet(descRows, { header: ['Property','Value'] }); wsDesc['!cols'] = [{ wch:30 }, { wch:70 }];
      XLSX.utils.book_append_sheet(wb, wsDesc, 'Description');

      const rawCopy = rawData.map(row => { const r = {}; Object.keys(row).forEach(k => { let v = row[k]; if(k.toLowerCase() === 'month' && typeof v === 'number' && v > 0){ v = excelSerialToDate(v); } r[k] = v; }); return r; });
      const wsRaw = XLSX.utils.json_to_sheet(rawCopy);
      wsRaw['!cols'] = Object.keys(rawCopy[0] || {}).map(k => ({ wch: Math.min(Math.max(String(k).length, 12), 40) }));
      XLSX.utils.book_append_sheet(wb, wsRaw, 'Raw Data');

      XLSX.writeFile(wb, 'Campaign_Spike_Summary.xlsx');
    }

    function formatSheetColumnsPerRow(ws){
      if(!ws || !ws['!ref']) return;
      const range = XLSX.utils.decode_range(ws['!ref']);
      const headers = {};
      for(let C=range.s.c; C<=range.e.c; ++C){
        const addr = XLSX.utils.encode_cell({r: range.s.r, c: C});
        const cell = ws[addr]; if(cell && cell.v) headers[cell.v] = C;
      }
      const idxBase = headers['Base_Metric'];
      const idxPrevVal = headers['Previous_Value'];
      const idxCurVal = headers['Current_Value'];
      const idxChange = headers['Change_Percent'];

      for(let R = range.s.r + 1; R <= range.e.r; ++R){
        if(idxChange !== undefined){ const addr = XLSX.utils.encode_cell({r:R, c: idxChange}); if(ws[addr] && ws[addr].v !== undefined) ws[addr].z = '0.00%'; }
        if(idxBase !== undefined && (idxPrevVal !== undefined || idxCurVal !== undefined)){
          const addrBase = XLSX.utils.encode_cell({r:R, c: idxBase});
          const baseCell = ws[addrBase]; const base = baseCell && baseCell.v ? String(baseCell.v).toUpperCase() : '';
          const prevAddr = idxPrevVal !== undefined ? XLSX.utils.encode_cell({r:R, c: idxPrevVal}) : null;
          const curAddr  = idxCurVal !== undefined ? XLSX.utils.encode_cell({r:R, c: idxCurVal}) : null;
          if(base === 'CTR'){
            if(prevAddr && ws[prevAddr] && ws[prevAddr].v !== undefined) ws[prevAddr].z = '0.00%';
            if(curAddr && ws[curAddr] && ws[curAddr].v !== undefined) ws[curAddr].z = '0.00%';
          } else {
            if(prevAddr && ws[prevAddr] && ws[prevAddr].v !== undefined) ws[prevAddr].z = '$0.00';
            if(curAddr && ws[curAddr] && ws[curAddr].v !== undefined) ws[curAddr].z = '$0.00';
          }
        }
      }
      ws['!cols'] = [ {wch:28},{wch:14},{wch:22},{wch:18},{wch:12},{wch:10},{wch:12},{wch:42} ];
    }
  </script>
</body>
</html>
